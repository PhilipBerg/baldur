---
title: "Baldur Yeast Tutorial"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Baldur Yeast Tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


# 1. Setup
This tutorial is quite fast and on a very simple data set (2 conditions only), for a more complicated tutorial for setup please see `vignette('baldur_ups_tutorial')`.
First we load `baldur` and setup the model dependent variables we need, then normalize the data and add the mean-variance trends.

```r
library(baldur)
# Setup design matrix
yeast_design <- model.matrix(~0+factor(rep(1:2, each = 3)))
colnames(yeast_design) <- paste0('ng', c(50, 100))
# Compare the first and second column of the design matrix
# with the following contrast matrix
yeast_contrast <- matrix(1:2, nrow = 1)

# Since baldur itself does not deal with missing data we remove the
# rows that have missing data for the purpose of the tutorial.
# Else, one would replace the filtering step with imputation but that is outside
# the scope of baldur
yeast_norm <- yeast %>%
  # Remove missing data
  tidyr::drop_na() %>%
  # Normalize data (this might already have been done if imputation was performed)
  psrn('identifier') %>%
  # Add mean-variance trends
  calculate_mean_sd_trends(yeast_design)
```
Importantly, note that the column names of the design matrix are unique subsets of the names of the columns within the conditions:

```r
colnames(yeast)
#> [1] "identifier" "ng50_1"     "ng50_2"     "ng50_3"     "ng100_1"    "ng100_2"    "ng100_3"
colnames(yeast_design)
#> [1] "ng50"  "ng100"
```
This is essential for `baldur` to know which columns to use in calculations and to perform transformations.

# 2. Trend-partitioning and uncertainty estimation
Next is to infer the mixture of the data and to estimate the parameters needed for `baldur`.
First we will setup the needed variables for using `baldur` without partitioning the data.
Then, partitioning and setting up `baldur` after trend-partitioning

```r
# Fit the gamma regression
gr_model <- fit_gamma_regression(yeast_norm, sd ~ mean)
# Estimate the uncertainty
unc_gr <- estimate_uncertainty(gr_model, yeast_norm, 'identifier', yeast_design)
```

# 3. Run the sampling procedure
Finally we sample the posterior of each row in the data.
First we sample assuming a single trend, then using the partitioning.

```r
# Single trend
gr_results <- gr_model %>%
  # Add hyper-priors for sigma
  estimate_gamma_hyperparameters(yeast_norm) %>%
  sample_posterior(
    'identifier',
    yeast_design,
    yeast_contrast,
    unc_gr,
    clusters = 10 # I highly recommend using parallel workers/clusters
  )               # this will greatly reduce the speed of running baldur
# The top hits then looks as follows:
gr_results %>%
  dplyr::arrange(err)
#> # A tibble: 1,802 × 21
#>    identifier    compa…¹       err   lfc lfc_025 lfc_50 lfc_975 lfc_eff lfc_r…²  sigma sigma…³ sigma…⁴ sigma…⁵ sigma…⁶
#>    <chr>         <chr>       <dbl> <dbl>   <dbl>  <dbl>   <dbl>   <dbl>   <dbl>  <dbl>   <dbl>   <dbl>   <dbl>   <dbl>
#>  1 Cre09.g40605… ng50 v… 3.11e-223 -6.19   -6.59  -6.19  -5.80    1765.   1.00  0.153   0.0829  0.139   0.303    1121.
#>  2 sp|P37302|AP… ng50 v… 4.54e-178 -1.51   -1.61  -1.51  -1.41    2792.   1.00  0.0552  0.0303  0.0507  0.106    1159.
#>  3 Cre12.g55410… ng50 v… 2.30e-164 -1.61   -1.73  -1.61  -1.48    3025.   0.999 0.0611  0.0326  0.0555  0.119    1126.
#>  4 sp|P38788|SS… ng50 v… 7.75e-152 -1.07   -1.15  -1.07  -0.989   3264.   1.00  0.0434  0.0235  0.0398  0.0861   1196.
#>  5 Cre14.g61670… ng50 v… 2.15e-126  4.55    4.18   4.55   4.94    2677.   1.00  0.179   0.0974  0.163   0.343    1417.
#>  6 Cre10.g42075… ng50 v… 3.23e-115 -4.15   -4.52  -4.16  -3.78    3809.   1.00  0.185   0.104   0.169   0.361    1321.
#>  7 sp|P09624|DL… ng50 v… 3.68e-100 -1.48   -1.62  -1.48  -1.34    3723.   1.00  0.0724  0.0392  0.0653  0.146    1083.
#>  8 Cre06.g30655… ng50 v… 2.21e- 93 -4.20   -4.61  -4.21  -3.80    2515.   1.00  0.184   0.0992  0.169   0.365    1181.
#>  9 Cre12.g53310… ng50 v… 2.56e- 93 -1.41   -1.55  -1.41  -1.27    2698.   1.00  0.0726  0.0385  0.0659  0.147    1006.
#> 10 sp|P32481|IF… ng50 v… 6.25e- 86 -1.59   -1.75  -1.59  -1.43    3394.   1.00  0.0850  0.0460  0.0775  0.168    1064.
#> # … with 1,792 more rows, 7 more variables: sigma_rhat <dbl>, lp <dbl>, lp_025 <dbl>, lp_50 <dbl>, lp_975 <dbl>,
#> #   lp_eff <dbl>, lp_rhat <dbl>, and abbreviated variable names ¹​comparison, ²​lfc_rhat, ³​sigma_025, ⁴​sigma_50,
#> #   ⁵​sigma_975, ⁶​sigma_eff
```
Here `err` is the probability of error, i.e., the two tail-density supporting the null-hypothesis, `lfc` is the estimated log$_2$-fold change, `sigma` is the common variance, and `lp` is the log-posterior.
Columns without suffix shows the mean estimate from the posterior, while the suffixes `_025`, `_50`, and `_975`, are the 2.5, 50.0, and 97.5, percentiles, respectively.
The suffixes `_eff` and `_rhat` are the diagnostic variables returned by `rstan` (please see the Stan manual for details).
In general, a larger `_eff` indicates a better sampling efficiency, and `_rhat` compares the mixing within chains against between the chains and should be smaller than 1.05.

# 4. Running Baldur with Latent Gamma Regression estimation
First we fit the LGMR model:

```r
yeast_lgmr <- fit_lgmr(yeast_norm, lgmr_model, cores = 5)
```

We can print the model with `print` and extract parameters of interest with `coef`:

```r
print(yeast_lgmr)
#> 
#> LGMR Model
#> 	mu=exp(-1.798332 - 0.322133 f(bar_y)) + kappa exp(7.062957 - 0.384178 f(bar_y))
#> 
#>  auxiliary:
#>         mean   se_mean      sd   2.5%    25%    50%    75%  97.5%  n_eff  Rhat
#> alpha  4.096  0.004359  0.2321  3.658  3.937  4.090  4.248  4.564   2836     1
#> nrmse  0.561  0.000234  0.0139  0.534  0.552  0.561  0.571  0.589   3524     1
#> 
#> 
#>  Coefficients:
#>        mean   se_mean      sd    2.5%     25%     50%     75%   97.5%  n_eff  Rhat
#> I    -1.798  0.000427  0.0257  -1.847  -1.816  -1.799  -1.781  -1.746   3612     1
#> I_L   7.063  0.000478  0.0419   6.981   7.035   7.063   7.091   7.145   7683     1
#> S     0.322  0.000262  0.0233   0.277   0.306   0.322   0.337   0.369   7902     1
#> S_L   0.384  0.000297  0.0351   0.315   0.361   0.384   0.408   0.453  13987     1
#> 
#> 
#>  theta:
#>               mean   se_mean      sd      2.5%     25%    50%    75%  97.5%  n_eff  Rhat
#> theta[1]     0.247  1.22e-03  0.2197  0.000469  0.0502  0.194  0.407  0.725  32661     1
#> theta[2]     0.699  2.45e-03  0.2531  0.017002  0.6268  0.774  0.868  0.993  10631     1
#> theta[3]     0.294  1.43e-03  0.2491  0.000544  0.0646  0.244  0.489  0.805  30225     1
#> theta[4]     0.347  1.73e-03  0.2697  0.000897  0.0877  0.317  0.573  0.864  24371     1
#> theta[5]     0.900  6.26e-04  0.0863  0.702821  0.8514  0.915  0.970  1.000  19040     1
#> theta[6]     0.295  1.48e-03  0.2468  0.000634  0.0664  0.248  0.490  0.800  27710     1
#> theta[7]     0.358  1.74e-03  0.2736  0.001028  0.0967  0.332  0.587  0.881  24847     1
#> theta[8]     0.973  1.79e-04  0.0314  0.887244  0.9592  0.984  0.996  1.000  30690     1
#> theta[9]     0.345  1.68e-03  0.2720  0.001019  0.0845  0.310  0.572  0.871  26135     1
#> theta[10]    0.233  1.17e-03  0.2090  0.000443  0.0485  0.179  0.379  0.698  31875     1
#> theta[11]    0.243  1.22e-03  0.2157  0.000507  0.0493  0.188  0.396  0.718  31435     1
#> theta[12]    0.713  2.43e-03  0.2414  0.026851  0.6491  0.780  0.873  0.994   9854     1
#> theta[13]    0.410  2.07e-03  0.2872  0.001659  0.1291  0.419  0.660  0.903  19284     1
#> theta[14]    0.843  1.10e-03  0.1444  0.487634  0.7851  0.868  0.944  0.999  17310     1
#> theta[15]    0.808  1.42e-03  0.1765  0.250897  0.7467  0.844  0.926  0.999  15505     1
#> theta[16]    0.299  1.50e-03  0.2514  0.000791  0.0666  0.245  0.499  0.818  28035     1
#> theta[17]    0.502  2.27e-03  0.2971  0.002609  0.2342  0.565  0.746  0.964  17174     1
#> theta[18]    0.337  1.62e-03  0.2677  0.000909  0.0807  0.299  0.559  0.857  27140     1
#> theta[19]    0.287  1.41e-03  0.2448  0.000768  0.0630  0.231  0.477  0.801  30090     1
#> theta[20]    0.492  2.29e-03  0.2958  0.002312  0.2226  0.552  0.733  0.966  16703     1
#> theta[21]    0.468  2.20e-03  0.2942  0.001908  0.1900  0.517  0.716  0.942  17938     1
#> theta[22]    0.353  1.72e-03  0.2733  0.000906  0.0926  0.321  0.582  0.875  25312     1
#> theta[23]    0.899  6.92e-04  0.0924  0.688489  0.8490  0.917  0.972  1.000  17819     1
#> theta[24]    0.980  1.35e-04  0.0238  0.914110  0.9708  0.989  0.997  1.000  31002     1
#> theta[25]    0.289  1.42e-03  0.2460  0.000705  0.0631  0.235  0.479  0.803  29915     1
#> theta[26]    0.297  1.45e-03  0.2490  0.000559  0.0652  0.248  0.493  0.805  29677     1
#> theta[27]    0.334  1.62e-03  0.2639  0.000856  0.0850  0.297  0.548  0.856  26584     1
#> theta[28]    0.539  2.32e-03  0.2923  0.003783  0.3012  0.610  0.773  0.976  15828     1
#> theta[29]    0.369  1.79e-03  0.2755  0.001159  0.1051  0.354  0.602  0.887  23683     1
#> theta[30]    0.236  1.16e-03  0.2142  0.000572  0.0460  0.178  0.386  0.712  34206     1
#> theta[31]    0.301  1.49e-03  0.2494  0.000781  0.0683  0.253  0.501  0.801  27835     1
#> theta[32]    0.266  1.35e-03  0.2307  0.000645  0.0566  0.210  0.437  0.764  29156     1
#> theta[33]    0.275  1.36e-03  0.2387  0.000647  0.0566  0.220  0.457  0.778  30879     1
#> theta[34]    0.299  1.42e-03  0.2486  0.000740  0.0679  0.252  0.494  0.808  30741     1
#> theta[35]    0.219  1.15e-03  0.2032  0.000480  0.0423  0.160  0.353  0.686  31248     1
#> theta[36]    0.323  1.60e-03  0.2614  0.000686  0.0783  0.280  0.533  0.845  26598     1
#> theta[37]    0.328  1.65e-03  0.2641  0.000759  0.0792  0.287  0.542  0.855  25625     1
#> theta[38]    0.791  1.77e-03  0.1916  0.124953  0.7362  0.833  0.915  0.997  11769     1
#> theta[39]    0.949  3.27e-04  0.0508  0.821593  0.9203  0.963  0.990  1.000  24095     1
#> theta[40]    0.674  2.10e-03  0.2587  0.017447  0.5761  0.744  0.857  0.993  15160     1
#> theta[41]    0.252  1.27e-03  0.2271  0.000506  0.0490  0.193  0.413  0.754  31761     1
#> theta[42]    0.492  2.27e-03  0.2990  0.002130  0.2137  0.546  0.739  0.967  17331     1
#> theta[43]    0.659  2.42e-03  0.2672  0.012888  0.5543  0.738  0.849  0.992  12164     1
#> theta[44]    0.251  1.29e-03  0.2224  0.000488  0.0513  0.198  0.410  0.741  29857     1
#> theta[45]    0.719  2.24e-03  0.2391  0.029083  0.6573  0.782  0.875  0.995  11353     1
#> theta[46]    0.215  1.14e-03  0.1971  0.000442  0.0421  0.160  0.350  0.662  30104     1
#> theta[47]    0.259  1.35e-03  0.2290  0.000523  0.0513  0.201  0.430  0.753  28956     1
#> theta[48]    0.458  2.23e-03  0.2946  0.001803  0.1764  0.495  0.709  0.938  17500     1
#> theta[49]    0.987  9.48e-05  0.0166  0.939888  0.9814  0.993  0.998  1.000  30796     1
#> theta[50]    0.229  1.17e-03  0.2074  0.000514  0.0448  0.173  0.372  0.694  31373     1
#> theta[51]    0.219  1.21e-03  0.1995  0.000425  0.0435  0.163  0.356  0.667  27304     1
#> theta[52]    0.222  1.19e-03  0.2040  0.000360  0.0424  0.165  0.362  0.683  29489     1
#> theta[53]    0.299  1.43e-03  0.2504  0.000734  0.0686  0.250  0.492  0.820  30474     1
#> theta[54]    0.253  1.26e-03  0.2238  0.000510  0.0516  0.196  0.413  0.741  31606     1
#> theta[55]    0.230  1.18e-03  0.2062  0.000541  0.0473  0.177  0.375  0.686  30675     1
#> theta[56]    0.269  1.29e-03  0.2312  0.000593  0.0576  0.217  0.440  0.764  32305     1
#> theta[57]    0.610  2.60e-03  0.2809  0.007798  0.4514  0.699  0.818  0.979  11660     1
#> theta[58]    0.921  4.99e-04  0.0719  0.748439  0.8788  0.938  0.981  1.000  20768     1
#> theta[59]    0.235  1.15e-03  0.2091  0.000542  0.0494  0.181  0.380  0.702  32790     1
#> theta[60]    0.772  1.78e-03  0.2031  0.080810  0.7135  0.817  0.903  0.997  12996     1
#> theta[61]    0.490  2.32e-03  0.2973  0.002696  0.2129  0.548  0.740  0.952  16365     1
#> theta[62]    0.334  1.67e-03  0.2642  0.000909  0.0826  0.298  0.556  0.842  25043     1
#> theta[63]    0.430  2.19e-03  0.2938  0.001728  0.1420  0.453  0.680  0.935  18040     1
#> theta[64]    0.928  4.63e-04  0.0675  0.764997  0.8888  0.945  0.984  1.000  21243     1
#> theta[65]    0.584  2.33e-03  0.2881  0.006503  0.3864  0.660  0.807  0.985  15226     1
#> theta[66]    0.305  1.56e-03  0.2550  0.000665  0.0648  0.255  0.511  0.815  26723     1
#> theta[67]    0.833  1.43e-03  0.1509  0.434018  0.7763  0.858  0.933  0.999  11125     1
#> theta[68]    0.393  2.01e-03  0.2858  0.001241  0.1114  0.391  0.640  0.897  20198     1
#> theta[69]    0.376  1.84e-03  0.2815  0.001163  0.1047  0.356  0.612  0.903  23372     1
#> theta[70]    0.537  2.51e-03  0.2974  0.002657  0.2832  0.619  0.775  0.972  14073     1
#> theta[71]    0.235  1.15e-03  0.2150  0.000411  0.0454  0.175  0.386  0.719  34763     1
#> theta[72]    0.952  3.05e-04  0.0488  0.826483  0.9260  0.967  0.992  1.000  25554     1
#> theta[73]    0.397  1.96e-03  0.2844  0.001471  0.1179  0.397  0.641  0.904  21019     1
#> theta[74]    0.242  1.22e-03  0.2178  0.000468  0.0467  0.184  0.398  0.722  31858     1
#> theta[75]    0.372  1.84e-03  0.2792  0.001118  0.1026  0.350  0.611  0.884  23098     1
#> theta[76]    0.906  6.05e-04  0.0829  0.720260  0.8589  0.923  0.972  1.000  18771     1
#> theta[77]    0.322  1.58e-03  0.2594  0.000763  0.0782  0.279  0.532  0.838  27109     1
#> theta[78]    0.263  1.33e-03  0.2291  0.000572  0.0564  0.208  0.435  0.751  29740     1
#> theta[79]    0.327  1.57e-03  0.2642  0.000639  0.0756  0.287  0.546  0.845  28379     1
#> theta[80]    0.981  1.23e-04  0.0223  0.919020  0.9733  0.990  0.998  1.000  32808     1
#> theta[81]    0.222  1.12e-03  0.2028  0.000426  0.0436  0.166  0.361  0.682  32699     1
#> theta[82]    0.268  1.31e-03  0.2316  0.000609  0.0584  0.213  0.438  0.766  31016     1
#> theta[83]    0.279  1.36e-03  0.2406  0.000753  0.0604  0.224  0.459  0.792  31139     1
#> theta[84]    0.965  2.20e-04  0.0370  0.869087  0.9482  0.978  0.994  1.000  28361     1
#> theta[85]    0.240  1.18e-03  0.2135  0.000625  0.0505  0.186  0.392  0.713  32589     1
#> theta[86]    0.268  1.29e-03  0.2359  0.000684  0.0542  0.211  0.442  0.779  33699     1
#> theta[87]    0.979  1.42e-04  0.0256  0.907497  0.9694  0.989  0.997  1.000  32544     1
#> theta[88]    0.254  1.30e-03  0.2258  0.000536  0.0502  0.198  0.416  0.749  30103     1
#> theta[89]    0.250  1.26e-03  0.2222  0.000601  0.0510  0.193  0.412  0.741  30860     1
#> theta[90]    0.322  1.55e-03  0.2633  0.000653  0.0749  0.277  0.535  0.855  28977     1
#> theta[91]    0.604  2.64e-03  0.2852  0.006151  0.4394  0.689  0.816  0.984  11641     1
#> theta[92]    0.419  2.10e-03  0.2901  0.001395  0.1384  0.430  0.670  0.919  19014     1
#> theta[93]    0.280  1.38e-03  0.2387  0.000568  0.0613  0.230  0.462  0.782  29741     1
#> theta[94]    0.970  2.01e-04  0.0343  0.877670  0.9543  0.982  0.996  1.000  29132     1
#> theta[95]    0.975  1.64e-04  0.0287  0.897606  0.9632  0.986  0.997  1.000  30482     1
#> theta[96]    0.964  2.36e-04  0.0399  0.857609  0.9458  0.978  0.995  1.000  28714     1
#> theta[97]    0.250  1.27e-03  0.2221  0.000602  0.0498  0.194  0.411  0.737  30598     1
#> theta[98]    0.935  4.13e-04  0.0621  0.785057  0.8998  0.952  0.986  1.000  22619     1
#> theta[99]    0.406  1.97e-03  0.2872  0.001209  0.1246  0.409  0.655  0.912  21220     1
#> theta[100]   0.979  1.35e-04  0.0244  0.912289  0.9697  0.989  0.997  1.000  32723     1
#>  [ reached getOption("max.print") -- omitted 1702 rows ]
# Extract the regression, alpha, and theta parameters and the NRMSE.
yeast_lgmr_coef <- coef(yeast_lgmr, pars = c("all"))
```

We can then estimate the uncertainty similar to the GR case:

```r
unc_lgmr <- estimate_uncertainty(yeast_lgmr, yeast_norm, 'identifier', yeast_design)
```

Then running the data and decision model:

```r
# Single trend
lgmr_results <- yeast_lgmr %>%
  # Add hyper-priors for sigma
  estimate_gamma_hyperparameters(yeast_norm) %>%
  sample_posterior(
    'identifier',
    yeast_design,
    yeast_contrast,
    unc_lgmr,
    clusters = 10
  )
```

# 5. Visualization of the results
`baldur` have two ways of visualizing the results 1) plotting sigma vs LFC and 2) Volcano plots.
To plot sigma against LFC we use `plot_sa`:

```r
gr_results %>%
  plot_sa(
    alpha = .05, # Level of significance
    lfc = 1      # Add LFC lines
  )

lgmr_results %>%
  plot_sa(
    alpha = .05, # Level of significance
    lfc = 1      # Add LFC lines
  )
```

![plot of chunk plotting_sa](plotting_sa-1yeast.png)![plot of chunk plotting_sa](plotting_sa-2yeast.png)

In general, a good decision is indicated by a lack of a trend between $\sigma$ and LFC.
We can see that Baludr with the LGMR model (second plot) has a lower trend compared to GR model (first plot) for which there is a trend for $\sigma$ to increase with LFC.
To make a volcano plot one uses `plot_volcano` in a similar fashion to `plot_sa`:

```r
gr_results %>%
  plot_volcano(
    alpha = .05, # Level of significance
    lfc = 1      # Add LFC lines
  )

lgmr_results %>%
  plot_volcano(
    alpha = .05, # Level of significance
    lfc = 1      # Add LFC lines
  )
```
![plot of chunk plotting_volc](plotting_volc-1yeast.png)
![plot of chunk plotting_volc](plotting_volc-2yeast.png)
